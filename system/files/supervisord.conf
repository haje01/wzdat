[supervisord]
nodaemon=true
environment=LANG="en_US.UTF-8",LC_ALL="en_US.UTF-8",HOME="/root",WZDAT_CFG="%(ENV_WZDAT_CFG)s",WZDAT_HOST="%(ENV_WZDAT_HOST)s"

[program:sshd]
command=/usr/sbin/sshd -D

[program:ipython]
directory=/solution/__notes__/%(ENV_WZDAT_PRJ)s
command=ipython notebook

[program:celery]
command=celery worker -A wzdat.dashboard.tasks -l info

[program:nginx]
command=/usr/sbin/nginx
stdout_events_enabled=true
stderr_events_enabled=true

[program:uwsgi]
command=uwsgi -x /etc/wzdat/uwsgi.xml

[program:redis]
command=redis-server

[program:cron]
command=cron -f

[program:register_cron]
command=/bin/bash -c "while true; do python -m wzdat.jobs register-cron; sleep 60; done"

[program:check_cache]
autorestart=true
command=/bin/bash -c "while inotifywait -e close_write -e delete --exclude "_wdfwd_*" -r /logdata; do for i in $(atq | cut -f 1); do atrm $i; done; echo 'cd /solution && WZDAT_CFG=/solution/%(ENV_WZDAT_SOL_PKG)s/%(ENV_WZDAT_PRJ)s/config.yml python -m wzdat.jobs cache-all' | at now + 10 min; done"

[program:clear_cache]
autorestart=true
command=/bin/bash -c "while inotifywait -e create --exclude "_wdfwd_*" -r /logdata; do for i in $(atq | cut -f 1); do atrm $i; done; done"
